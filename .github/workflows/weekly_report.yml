name: tinyvc Weekly Report

on:
  schedule:
    - cron: '0 8 * * 0'  # Every Sunday at 8:00 AM UTC
  workflow_dispatch:  # Manual trigger for testing

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements*.txt') }}
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run tests with coverage
        run: pytest tests/ --tb=short -v

  generate-report:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Restore data lake from previous runs
        uses: actions/cache@v4
        with:
          path: data/
          key: data-lake-${{ github.run_number }}
          restore-keys: |
            data-lake-
      
      - name: Run pipeline
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
          WEEKLY_BUDGET: ${{ secrets.WEEKLY_BUDGET || '50' }}
          INVESTMENT_HORIZON: ${{ secrets.INVESTMENT_HORIZON || '20' }}
        run: python -m src.main
      
      - name: Generate dashboard data
        run: python -m scripts.generate_dashboard
      
      - name: Save data lake for next run
        uses: actions/cache@v4
        with:
          path: data/
          key: data-lake-${{ github.run_number }}
      
      - name: Upload dashboard as Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/
  
  deploy-dashboard:
    needs: generate-report
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4


